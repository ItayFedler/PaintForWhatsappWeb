var srcUrl,context,image,canvas,boundings,newwidth,newheight,orgImage,undoStack=[],redoStack=[];function updateProgress(b){var c=document.getElementById("myBar"),d=document.getElementById("progressDiv");d.style.display="block";100<=b?d.style.display="none":c.style.width=b+"%"}function createGuid(){function b(c){var d=(Math.random().toString(16)+"000000000").substr(2,8);return c?"-"+d.substr(0,4)+"-"+d.substr(4,4):d}return b()+b(!0)+b(!0)+b()}
function fillAlpha(b,c){b.save();b.globalAlpha=1;b.setTransform(1,0,0,1,0,0);b.filter="none";b.globalCompositeOperation="destination-over";b.fillStyle=c;b.fillRect(0,0,b.canvas.width,b.canvas.height);b.restore()}
function setCanvasUrl(b){srcUrl=b;image=new Image;image.src=srcUrl;image.onload=function(){var c=image.width,d=image.height,g=1;console.log(image.width+", "+image.height);700<c&&(g=700/c);nwidth=c*g;nheight=d*g;canvas.width=nwidth;canvas.height=nheight;fillAlpha(context,"white");context.drawImage(image,0,0,nwidth,nheight);newheight=nheight;newwidth=nwidth;orgImage=image;undoStack.push(orgImage)}}
window.onload=function(){function b(a){var e=canvas.getBoundingClientRect();f=a.clientX-e.left;v=a.clientY-e.top}canvas=document.getElementById("paint-canvas");blockcanvas=document.getElementById("block-canvas");context=canvas.getContext("2d");boundings=canvas.getBoundingClientRect();var c=document.getElementById("textsize"),d=document.getElementById("textfont"),g=document.getElementsByClassName("hoveringtext")[0];g.style.fontFamily=d.value;g.style.fontSize=c.value;g.style.color=h||"black";var n=
document.getElementById("bold"),p=document.getElementById("italic");n.addEventListener("click",function(a){g.style.fontWeight=1==n.checked?"bold":""});p.addEventListener("click",function(a){g.style.fontStyle=1==p.checked?"italic":""});var l=document.getElementById("hoveringtextarea"),h="black",f=0,v=0;context.strokeStyle="black";context.lineWidth=1;context.lineJoin="round";context.lineCap="round";var x=!1,t=!1;document.getElementsByClassName("colors")[0].addEventListener("click",function(a){context.strokeStyle=
a.target.value||"black";h=a.target.value||"black";g.style.color=h||"black"});var m=document.getElementsByClassName("brushes")[0],w=document.getElementById("brushsize"),u=document.getElementById("draggablediv"),k=document.getElementById("draggabledivtext");dragElement(u);dragElement(k);context.lineWidth=w.value;setInputFilter(w,function(a){return/^\d*\.?\d*$/.test(a)});m.addEventListener("click",function(a){"brushsize"!=a.target.id&&(context.lineWidth=parseInt(w.value)+parseInt(a.target.value),w.value=
context.lineWidth)});m.addEventListener("input",function(a){"brushsize"==a.target.id&&(context.lineWidth=parseInt(a.target.value))});document.getElementById("cu");(function(){canvas.addEventListener("mousedown",function(a){if(1==t)if("block"!=k.style.display)k.style.left=f,k.style.top=v,k.style.display="block";else{a="";1==n.checked&&(a+="bold ");1==p.checked&&(a+="italic ");context.font=a+c.value+"px "+d.value;context.fillStyle=h;a=canvas.getBoundingClientRect();var e=l.getBoundingClientRect();areaX=
e.left-a.left;areaY=e.top-a.top+parseInt(c.value);console.log("x="+areaX);console.log("y="+areaY);context.fillText(l.value,areaX+2,areaY+2);t=!1;u.style.display="none";k.style.display="none";canvas.style.cursor="crosshair";a=new Image;a.src=canvas.toDataURL();undoStack.push(a)}else b(a),x=!0,context.beginPath(),context.moveTo(f,v)});canvas.addEventListener("mousemove",function(a){b(a);x&&(context.lineTo(f,v),context.stroke())});canvas.addEventListener("mouseup",function(a){b(a);x=!1;a=new Image;a.src=
canvas.toDataURL();undoStack.push(a)})})();document.getElementById("reset").addEventListener("click",function(){context.clearRect(0,0,canvas.width,canvas.height);fillAlpha(context,"white");context.drawImage(orgImage,0,0,canvas.width,canvas.height);undoStack.push(image)});m=document.getElementById("help");m.addEventListener("click",function(){window.open(chrome.runtime.getURL("help.html"))});document.getElementById("undo").addEventListener("click",function(){1<undoStack.length&&(context.clearRect(0,
0,canvas.width,canvas.height),fillAlpha(context,"white"),redoStack.push(undoStack.pop()),context.drawImage(undoStack[undoStack.length-1],0,0,canvas.width,canvas.height))});m=document.getElementById("redo");m.addEventListener("click",function(){0<redoStack.length&&(context.clearRect(0,0,canvas.width,canvas.height),fillAlpha(context,"white"),undoStack.push(redoStack.pop()),context.drawImage(undoStack[undoStack.length-1],0,0,canvas.width,canvas.height))});m=document.getElementById("addtext");document.getElementById("doneaddtext").addEventListener("click",
function(a){if("doneaddtext"==a.target.id){a="";1==n.checked&&(a+="bold ");1==p.checked&&(a+="italic ");context.font=a+c.value+"px "+d.value;context.fillStyle=h;a=canvas.getBoundingClientRect();var e=l.getBoundingClientRect();areaX=e.left-a.left;areaY=e.top-a.top+parseInt(c.value);console.log("x="+areaX);console.log("y="+areaY);context.fillText(l.value,areaX+2,areaY+2);t=!1;u.style.display="none";k.style.display="none";canvas.style.cursor="crosshair";a=new Image;a.src=canvas.toDataURL();undoStack.push(a)}});
m.addEventListener("click",function(){if(0==t){t=!0;u.style.display="block";k.style.display="none";canvas.style.cursor="text";document.getElementsByClassName("textprop");var a=document.getElementById("textsize");setInputFilter(a,function(e){return/^\d*\.?\d*$/.test(e)})}else t=!1,u.style.display="none",k.style.display="none"});d.addEventListener("input",function(a){"textfont"==a.target.id&&(g.style.fontFamily=d.value)});c.addEventListener("input",function(a){"textsize"==a.target.id&&(g.style.fontSize=
c.value)});document.getElementById("save").addEventListener("click",function(){var a=prompt("Please enter image name"),e=canvas.toDataURL(),q=document.createElement("a");q.href=e;q.download=a||"drawing";q.click()});document.getElementById("share").addEventListener("click",function(){chrome.tabs.getSelected(null,function(a){a=canvas.toDataURL();var e=new XMLHttpRequest;e.open("POST","https://paintforwhatsapp.com/app/uploadhtml.php",!0);var q=new FormData,y=createGuid();q.append("name",y);q.append("data",
a);e.upload.onprogress=function(r){r.lengthComputable&&(r=r.loaded/r.total*100,console.log(r+"% uploaded"),updateProgress(r),100===r&&chrome.tabs.getSelected(null,function(z){window.open("https://web.whatsapp.com/send?text=https://paintforwhatsapp.com/app/upload/"+(y+"/preview.html "),"","height=800,width=700,left=100,top=100,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes")}))};e.onload=function(){};e.send(q)})})};
function dragElement(b){function c(f){f=f||window.event;f.preventDefault();l=f.clientX;h=f.clientY;document.onmouseup=g;document.onmousemove=d}function d(f){f=f||window.event;n=l-f.clientX;p=h-f.clientY;l=f.clientX;h=f.clientY;b.style.top=b.offsetTop-p+"px";b.style.left=b.offsetLeft-n+"px"}function g(){document.onmouseup=null;document.onmousemove=null}var n=0,p=0,l=0,h=0;document.getElementById(b.id+"header")&&(document.getElementById(b.id+"header").onmousedown=c)}
function setInputFilter(b,c){"input keydown keyup mousedown mouseup select contextmenu drop".split(" ").forEach(function(d){b.addEventListener(d,function(){c(this.value)?(this.oldValue=this.value,this.oldSelectionStart=this.selectionStart,this.oldSelectionEnd=this.selectionEnd):this.hasOwnProperty("oldValue")?(this.value=this.oldValue,this.setSelectionRange(this.oldSelectionStart,this.oldSelectionEnd)):this.value=""})})};